<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soot Blower ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- í°íŠ¸: í”„ë¦¬í…ë‹¤ë“œ -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* í™”ë©´ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
        .page-section { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .page-section.active { display: block; opacity: 1; }

        /* =========================================
           1. ë©”ì¸ ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼ (ì‹¬í”Œ ë°•ìŠ¤í˜•)
           ========================================= */
        .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        
        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 0;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 80px;
        }
        
        /* ì™¼ìª½ ì»¬ëŸ¬ë°” */
        .dashboard-card::before {
            content: ''; position: absolute; top: 0; bottom: 0; left: 0; width: 6px;
        }
        .dashboard-card.blue::before { background-color: #3b82f6; }
        .dashboard-card.red::before { background-color: #ef4444; }
        .dashboard-card.dark::before { background-color: #334155; }

        .dashboard-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .dashboard-card:active { transform: scale(0.98); background-color: #f1f5f9; }
        
        /* í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .card-title { font-size: 16px; font-weight: 800; color: #1e293b; letter-spacing: -0.5px; }
        .card-desc { font-size: 11px; color: #64748b; margin-top: 2px; }
        
        /* í˜¸ê¸° ì„ íƒ ë²„íŠ¼ìš© ìŠ¤íƒ€ì¼ */
        .unit-card { height: 120px; } 
        .unit-title { font-size: 32px; font-weight: 900; color: #1e293b; }

        /* =========================================
           2. ìƒì„¸ í™”ë©´ ìŠ¤íƒ€ì¼
           ========================================= */
        .boiler-container {
            background: white; border-radius: 24px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 20px; position: relative; aspect-ratio: 1 / 1; 
            max-width: 400px; margin: 0 auto; border: 1px solid #f1f5f9;
        }
        .boiler-grid { 
            display: grid; 
            grid-template-columns: 60px 1fr 60px; 
            grid-template-rows: 60px 1fr 60px; 
            height: 100%; gap: 8px; position: relative; z-index: 10; 
        }
        .corner-number { position: absolute; font-weight: 900; font-size: 3rem; color: #ffe4e6; line-height: 1; z-index: 0; user-select: none; }
        .cn-1 { bottom: 10px; left: 15px; } .cn-2 { top: 10px; left: 15px; } 
        .cn-3 { top: 10px; right: 15px; } .cn-4 { bottom: 10px; right: 15px; }
        
        .center-status-box {
            grid-column: 2 / 3; grid-row: 2 / 3; border: 2px dashed #cbd5e1; border-radius: 12px;
            background-color: #f8fafc; display: flex; flex-direction: column; padding: 8px; overflow: hidden;
        }
        
        .device-btn {
            width: 42px; height: 42px; background: white; border: 1.5px solid #475569; border-radius: 6px;
            color: #1e293b; font-weight: 700; font-size: 14px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.15s; cursor: pointer; z-index: 20;
        }
        .device-btn:active { transform: scale(0.92); background-color: #f1f5f9; }
        .device-btn:hover { border-color: #2563eb; color: #2563eb; }
        
        .label-sm { font-size: 9px; line-height: 1; color: #64748b; margin-bottom: 1px; }
        .label-lg { font-size: 15px; line-height: 1; }
        
        .side-container { display: flex; align-items: center; justify-content: space-evenly; width: 100%; height: 100%; }
        .side-top { grid-column: 2/3; grid-row: 1/2; flex-direction: row; align-items: flex-end; padding-bottom: 4px; }
        .side-bottom { grid-column: 2/3; grid-row: 3/4; flex-direction: row; align-items: flex-start; padding-top: 4px; }
        .side-left { grid-column: 1/2; grid-row: 2/3; flex-direction: column; align-items: flex-end; padding-right: 4px; }
        .side-right { grid-column: 3/4; grid-row: 2/3; flex-direction: column; align-items: flex-start; padding-left: 4px; }
        
        .status-row {
            display: flex; justify-content: space-between; align-items: center; padding: 5px 0; 
            border-bottom: 1px solid #f1f5f9; font-size: 11px; color: #475569; cursor: pointer;
        }
        .status-row:last-child { border-bottom: none; }
        .status-row:hover { color: #2563eb; }
        .badge { background: #e2e8f0; color: #64748b; padding: 1px 5px; border-radius: 99px; font-size: 10px; font-weight: bold; }
        .badge.active { background: #ef4444; color: white; }

        /* ë©”ëª¨ì¥ ìŠ¤íƒ€ì¼ */
        .memo-container {
            margin-top: 20px; background-color: white; border-radius: 16px; padding: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
        }
        .memo-input {
            width: 100%; border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; font-size: 13px;
            resize: none; height: 70px; background-color: #f8fafc; transition: all 0.2s;
        }
        .memo-input:focus { outline: none; border-color: #3b82f6; background-color: white; }
        .memo-btn {
            margin-top: 8px; width: 100%; background-color: #334155; color: white; padding: 10px;
            border-radius: 8px; font-weight: bold; font-size: 13px; transition: background 0.2s;
        }
        .memo-btn:active { transform: scale(0.98); }
        .memo-summary-btn {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; padding: 10px 12px; border-radius: 8px; background-color: #f1f5f9;
            border: 1px solid #e2e8f0; margin-top: 8px; font-weight: 700; font-size: 12px;
            color: #475569; cursor: pointer; transition: all 0.2s;
        }
        .memo-count-badge { background-color: #94a3b8; color: white; padding: 1px 6px; border-radius: 99px; font-size: 10px; font-weight: 800; }
        .memo-count-badge.active { background-color: #ef4444; }

        /* ìƒˆë¡œìš´ ëŒ€ì‹œë³´ë“œ ê·¸ë¦¬ë“œ (3ì—´) */
        #total-dashboard-grid { 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
        }
        #total-dashboard-grid .dashboard-card {
            height: 90px;
            padding: 10px;
            justify-content: space-between;
        }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen flex flex-col pb-6">

    <!-- ================= PAGE 0: í˜¸ê¸° ì„ íƒ ================= -->
    <div id="page-unit-selection" class="page-section active p-5">
        <header class="mb-10 mt-8 text-center">
            <h1 class="text-2xl font-extrabold text-slate-800 tracking-tight">Soot Blower <span class="text-blue-600">Manager</span></h1>
            <p class="text-slate-400 text-xs mt-2 font-medium">ê´€ë¦¬í•  í˜¸ê¸°(Unit)ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>
        </header>

        <div class="dashboard-grid mb-10">
            <!-- í˜¸ê¸° ì„ íƒ ë²„íŠ¼ -->
            <div class="dashboard-card unit-card blue" onclick="selectUnit('UNIT 3')">
                <div class="unit-title">#3</div>
                <div class="card-desc">3í˜¸ê¸° ì„¤ë¹„</div>
            </div>
            <div class="dashboard-card unit-card red" onclick="selectUnit('UNIT 4')">
                <div class="unit-title">#4</div>
                <div class="card-desc">4í˜¸ê¸° ì„¤ë¹„</div>
            </div>
        </div>
        
        <!-- ================= ì „ì²´ ì‘ì—… í˜„í™© ëŒ€ì‹œë³´ë“œ ================= -->
        <div id="total-summary-section" class="mt-4">
            <div class="flex items-center mb-3 pl-1">
                <div class="w-1 h-3 bg-red-600 rounded-full mr-2"></div>
                <h2 class="text-xs font-bold text-red-600 uppercase tracking-widest">ì „ì²´ ì‘ì—… í˜„í™© (ëˆ„ì )</h2>
            </div>
            <div id="total-dashboard-grid" class="dashboard-grid">
                <!-- Summary cards will be injected here -->
                <div class="col-span-2 text-center py-10 text-slate-400" id="totalSummaryLoading">
                    <div class="flex items-center justify-center h-full text-slate-300 text-xs">
                        <div class="animate-spin mr-2 rounded-full border-2 border-slate-300 border-t-slate-500 h-4 w-4"></div>
                        ë°ì´í„° ë¡œë“œ ì¤‘...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= PAGE 1: ê·¸ë£¹ ì„ íƒ ================= -->
    <div id="page-group-selection" class="page-section p-5">
        <header class="mb-6 mt-4 flex items-center justify-between">
            <button onclick="goUnitSelection()" class="text-slate-400 hover:text-slate-600 font-bold text-xs px-2 py-1 border border-slate-200 rounded">
                â—€ í˜¸ê¸° ë³€ê²½
            </button>
            <div class="text-center flex-1 mr-12">
                <h1 class="text-xl font-extrabold text-slate-800 tracking-tight" id="headerUnitTitle">#3í˜¸ê¸°</h1>
            </div>
        </header>
        
        <!-- Short Section -->
        <div class="mb-8">
            <div class="flex items-center mb-3 pl-1">
                <div class="w-1 h-3 bg-blue-600 rounded-full mr-2"></div>
                <h2 class="text-xs font-bold text-blue-600 uppercase tracking-widest">Short Blower (G1-G4.5)</h2>
            </div>
            <div id="list-short" class="dashboard-grid"></div>
        </div>

        <!-- Long Section -->
        <div>
            <div class="flex items-center mb-3 pl-1">
                <div class="w-1 h-3 bg-red-600 rounded-full mr-2"></div>
                <h2 class="text-xs font-bold text-red-600 uppercase tracking-widest">Long Blower (G5-G9)</h2>
            </div>
            <div id="list-long" class="dashboard-grid"></div>
        </div>
    </div>

    <!-- ================= PAGE 2: ìƒì„¸ í™”ë©´ ================= -->
    <div id="page-detail" class="page-section p-4 h-screen flex flex-col pb-10 overflow-y-auto">
        <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="flex justify-between items-center mb-6 px-2">
            <button onclick="goGroupSelection()" class="flex items-center text-slate-500 hover:text-slate-800 font-bold text-sm transition-colors">
                â—€ ê·¸ë£¹ ì„ íƒ
            </button>
            <div class="text-right">
                <h2 id="detail-title" class="font-extrabold text-xl text-slate-800 tracking-tight">GROUP 1</h2>
                <p id="detail-desc" class="text-[10px] text-slate-400 font-bold uppercase tracking-wide hidden"></p>
            </div>
        </div>

        <!-- ë©”ì¸ ë³´ì¼ëŸ¬ ì»¨í…Œì´ë„ˆ -->
        <div class="flex-none flex items-center justify-center">
            <div class="boiler-container w-full">
                <div class="corner-number cn-1">1</div>
                <div class="corner-number cn-2">2</div>
                <div class="corner-number cn-3">3</div>
                <div class="corner-number cn-4">4</div>

                <div class="boiler-grid">
                    <!-- ì¤‘ì•™ ìƒíƒœì°½ -->
                    <div class="center-status-box" id="centerBox">
                        <!-- ì´ˆê¸° ë¡œë”© ìƒíƒœ -->
                    </div>
                    
                    <div id="area-top" class="side-container side-top"></div>
                    <div id="area-bottom" class="side-container side-bottom"></div>
                    <div id="area-left" class="side-container side-left"></div>
                    <div id="area-right" class="side-container side-right"></div>
                </div>
            </div>
        </div>

        <!-- íŠ¹ì´ì‚¬í•­ ë©”ëª¨ì¥ -->
        <div class="memo-container">
            <h3 class="text-sm font-bold text-slate-600 mb-2 flex items-center">
                <span class="mr-2">ğŸ“</span> í˜„ì¥ íŠ¹ì´ì‚¬í•­ / í”¼ë“œë°±
            </h3>
            <textarea id="memoInput" class="memo-input" placeholder="ì˜ˆ) 3ë²ˆ ê¸°ê¸° ì†ŒìŒ ë°œìƒ, ë¹„ê³„ ì„¤ì¹˜ í•„ìš” ë“±"></textarea>
            <button onclick="submitMemo()" class="memo-btn">ë©”ëª¨ ì €ì¥</button>
            
            <button id="memoSummaryButton" onclick="openHistoryModal('NOTE', 'GROUP')" class="memo-summary-btn">
                <span>íŠ¹ì´ì‚¬í•­ ì¢…í•© í™•ì¸</span>
                <span id="memoCountBadge" class="memo-count-badge">0ê±´</span>
            </button>
        </div>
        
        <div class="h-10"></div>
    </div>

    <!-- ================= ì‘ì—… ì…ë ¥ ëª¨ë‹¬ ================= -->
    <div id="actionModal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 p-4 backdrop-blur-[2px] transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs overflow-hidden transform scale-100 transition-transform">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-lg" id="modalTitle">No. 00</h3>
                    <p class="text-slate-400 text-xs" id="modalSubtitle">Group Name</p>
                </div>
                <span class="bg-blue-500 text-[10px] font-bold px-2 py-1 rounded">ì‘ì—… ì„ íƒ</span>
            </div>
            <div class="p-4 grid grid-cols-1 gap-2">
                <button onclick="submitAction('ì¼€ì´ë¸” êµì²´')" class="w-full p-3 border rounded-xl hover:bg-blue-50 hover:border-blue-500 hover:text-blue-700 font-bold text-slate-600 text-sm transition-all text-left flex items-center"><span class="w-6 text-center mr-2">ğŸ”Œ</span> 1. ì¼€ì´ë¸” êµì²´</button>
                <button onclick="submitAction('ì „ë™ê¸° ì†Œì†')" class="w-full p-3 border rounded-xl hover:bg-red-50 hover:border-red-500 hover:text-red-700 font-bold text-slate-600 text-sm transition-all text-left flex items-center"><span class="w-6 text-center mr-2">ğŸ”¥</span> 2. ì „ë™ê¸° ì†Œì†</button>
                <!-- [ìˆ˜ì •ì™„ë£Œ] ì˜¤íƒ€ ìˆ˜ì •ë¨: > ì¶”ê°€ -->
                <button onclick="submitAction('ì „ë™ê¸° ë² ì–´ë§ êµì²´')" class="w-full p-3 border rounded-xl hover:bg-orange-50 hover:border-orange-500 hover:text-orange-700 font-bold text-slate-600 text-sm transition-all text-left flex items-center"><span class="w-6 text-center mr-2">âš™ï¸</span> 3. ë² ì–´ë§ êµì²´</button>
                <button onclick="submitAction('ì „ë™ê¸° ì—­ìƒ')" class="w-full p-3 border rounded-xl hover:bg-yellow-50 hover:border-yellow-500 hover:text-yellow-700 font-bold text-slate-600 text-sm transition-all text-left flex items-center"><span class="w-6 text-center mr-2">âš ï¸</span> 4. ì „ë™ê¸° ì—­ìƒ</button>
                <button onclick="submitAction('ë¦¬ë¯¸íŠ¸ ì •ë¹„ [íšŒë¡œ]')" class="w-full p-3 border rounded-xl hover:bg-green-50 hover:border-green-500 hover:text-green-700 font-bold text-slate-600 text-sm transition-all text-left flex items-center"><span class="w-6 text-center mr-2">âš¡</span> 5. ë¦¬ë¯¸íŠ¸ ì •ë¹„ [íšŒë¡œ]</button>
                <button onclick="submitAction('MOV ì •ë¹„ [íšŒë¡œ]')" class="w-full p-3 border rounded-xl hover:bg-green-50 hover:border-green-500 hover:text-green-700 font-bold text-slate-600 text-sm transition-all text-left flex items-center"><span class="w-6 text-center mr-2">ğŸ”‹</span> 6. MOV ì •ë¹„ [íšŒë¡œ]</button>
                <button onclick="submitAction('ë‹¨ë¡œê¸° ì •ë¹„ [íšŒë¡œ]')" class="w-full p-3 border rounded-xl hover:bg-green-50 hover:border-green-500 hover:text-green-700 font-bold text-slate-600 text-sm transition-all text-left flex items-center"><span class="w-6 text-center mr-2">ğŸ’¡</span> 7. ë‹¨ë¡œê¸° ì •ë¹„ [íšŒë¡œ]</button>
                <button onclick="submitAction('MC ì •ë¹„ [íšŒë¡œ]')" class="w-full p-3 border rounded-xl hover:bg-green-50 hover:border-green-500 hover:text-green-700 font-bold text-slate-600 text-sm transition-all text-left flex items-center"><span class="w-6 text-center mr-2">â—»ï¸</span> 8. MC ì •ë¹„ [íšŒë¡œ]</button>
                <button onclick="submitAction('ê¸°ê³„ì  ê³ ì°© [ê¸°ê³„]')" class="w-full p-3 border rounded-xl hover:bg-purple-50 hover:border-purple-500 hover:text-purple-700 font-bold text-slate-600 text-sm transition-all text-left flex items-center"><span class="w-6 text-center mr-2">ğŸ”§</span> 9. ê¸°ê³„ì  ê³ ì°© [ê¸°ê³„]</button>
            </div>
            <div class="bg-slate-50 p-3 text-center border-t cursor-pointer hover:bg-slate-100 transition-colors" onclick="closeModal('actionModal')"><span class="text-slate-500 font-bold text-sm">ë‹«ê¸°</span></div>
        </div>
    </div>

    <!-- ================= ì´ë ¥ í™•ì¸ ëª¨ë‹¬ ================= -->
    <div id="historyModal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-[60] p-4 backdrop-blur-[2px]">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm h-3/4 flex flex-col overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-white sticky top-0">
                <h3 class="font-bold text-lg text-slate-800" id="historyTitle">ì´ë ¥</h3>
                <button onclick="closeModal('historyModal')" class="text-slate-400 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-0 bg-slate-50">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-100 sticky top-0"><tr><th class="px-4 py-3">ë‚ ì§œ</th><th class="px-2 py-3">ê¸°ê¸°/ìœ„ì¹˜</th><th class="px-4 py-3">ë‚´ìš©</th></tr></thead>
                    <tbody id="historyListBody" class="text-slate-700 divide-y divide-slate-200 bg-white"></tbody>
                </table>
                <div id="noHistoryMsg" class="hidden p-10 text-center text-slate-400 text-sm">ê¸°ë¡ëœ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
    <div id="loadingOverlay" class="fixed inset-0 hidden items-center justify-center z-[70] bg-white/80 backdrop-blur-sm">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-3"></div>
            <span class="font-bold text-slate-600 animate-pulse">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</span>
        </div>
    </div>

    <!-- Custom Toast/Alert Message Box -->
    <div id="toastMessage" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-3 rounded-xl shadow-lg font-bold text-sm hidden transition-opacity duration-300 z-[80]"></div>

    <script>
        // â˜…â˜…â˜…â˜…â˜… [í•„ìˆ˜] ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ URL ì…ë ¥ â˜…â˜…â˜…â˜…â˜…
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwyJgKM4gfPmd3qHx7XuuazUENcOKMvQ_oBZ_6HpVOzV1WeHYMjbglkxSQ_pMB2BRno/exec";

        let currentUnit = null;
        let currentSelection = { group: null, deviceNo: null };
        let currentGroupData = [];
        let totalCounts = {}; // ì „ì²´ ìš”ì•½ ê±´ìˆ˜
        let totalDataRecords = []; // ì „ì²´ ë°ì´í„° ë ˆì½”ë“œ
        
        const STATUS_CATEGORIES = [
            { code: 'C', label: 'ì¼€ì´ë¸” êµì²´' }, 
            { code: 'MB', label: 'ì „ë™ê¸° ì†Œì†' }, 
            { code: 'BR', label: 'ë² ì–´ë§ êµì²´' }, 
            { code: 'RP', label: 'ì „ë™ê¸° ì—­ìƒ' },
            { code: 'LR', label: 'ë¦¬ë¯¸íŠ¸ ì •ë¹„' }, 
            { code: 'MV', label: 'MOV ì •ë¹„' },
            { code: 'DS', label: 'ë‹¨ë¡œê¸° ì •ë¹„' }, 
            { code: 'MC', label: 'MC ì •ë¹„' },
            { code: 'MS', label: 'ê¸°ê³„ì  ê³ ì°©' }, 
            { code: 'NOTE', label: 'íŠ¹ì´ì‚¬í•­ ë©”ëª¨' } 
        ];

        // í‚¤ì›Œë“œ ë§¤ì¹­ ë¡œì§ (ê³µë°± ë¬´ì‹œ)
        function getCategoryByAction(action) {
            let str = action ? String(action) : '';
            str = str.replace(/\s+/g, ''); 

            if (str.includes('ì¼€ì´ë¸”')) return 'C';
            if (str.includes('ì†Œì†')) return 'MB';      
            if (str.includes('ë² ì–´ë§')) return 'BR';    
            if (str.includes('ì—­ìƒ')) return 'RP';      
            if (str.includes('ë¦¬ë¯¸íŠ¸')) return 'LR';    
            if (str.includes('MOV')) return 'MV';       
            if (str.includes('ë‹¨ë¡œê¸°')) return 'DS';    
            if (str.includes('MC')) return 'MC';        
            if (str.includes('ê³ ì°©')) return 'MS';      
            
            return 'ETC';
        }
        
        function calculateTotalCounts(data) {
            const counts = {};
            STATUS_CATEGORIES.forEach(cat => counts[cat.code] = 0);
            
            data.forEach(item => {
                let code;
                if (item.device === 'NOTE') {
                    code = 'NOTE';
                } else {
                    code = getCategoryByAction(item.action); 
                }
                if (counts[code] !== undefined) counts[code]++;
            });
            return counts;
        }
        
        // ì „ì²´ ì‘ì—… í˜„í™© ë°ì´í„° ë¡œë“œ
        function fetchTotalSummary() {
            const loadingEl = document.getElementById('totalSummaryLoading');
            const gridEl = document.getElementById('total-dashboard-grid');

            if (GOOGLE_SCRIPT_URL.includes("ì—¬ê¸°ì—")) {
                loadingEl.innerHTML = `URL ë¯¸ì„¤ì • (ë°±ì—”ë“œ ì—°ë™ ë¶ˆê°€)`;
                return;
            }
            
            gridEl.innerHTML = `<div class="col-span-3 text-center py-10 text-slate-400">
                    <div class="flex items-center justify-center h-full text-slate-300 text-xs">
                        <div class="animate-spin mr-2 rounded-full border-2 border-slate-300 border-t-slate-500 h-4 w-4"></div>
                        ë°ì´í„° ê°±ì‹  ì¤‘...
                    </div>
                </div>`;
            
            const separator = GOOGLE_SCRIPT_URL.includes('?') ? '&' : '?';
            const cacheBuster = `${separator}t=${new Date().getTime()}`;

            fetch(GOOGLE_SCRIPT_URL + cacheBuster) 
                .then(res => res.json())
                .then(data => {
                    let finalData = data;
                    if (!Array.isArray(data)) {
                        if (data.result && Array.isArray(data.result)) finalData = data.result;
                        else if (data.data && Array.isArray(data.data)) finalData = data.data;
                        else finalData = [];
                    }

                    totalDataRecords = finalData; 
                    totalCounts = calculateTotalCounts(finalData);
                    
                    renderTotalDashboard();
                })
                .catch(err => {
                    console.error("Total summary fetch failed:", err);
                    gridEl.innerHTML = `<div class="col-span-3 text-center py-10 text-red-400">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>`;
                });
        }
        
        function renderTotalDashboard() {
            const grid = document.getElementById('total-dashboard-grid');
            grid.innerHTML = ''; 

            const repairCategories = STATUS_CATEGORIES.filter(c => c.code !== 'NOTE');
            
            if (repairCategories.length === 0) {
                grid.innerHTML = `<div class="col-span-3 text-center py-10 text-slate-400">ì •ë¹„ í•­ëª©ì´ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            repairCategories.forEach(cat => {
                const count = totalCounts[cat.code] || 0;
                const barColor = count > 0 ? 'red' : 'dark'; 
                
                const card = document.createElement('div');
                card.className = `dashboard-card ${barColor} relative`;
                card.style.cursor = 'pointer'; 
                card.onclick = () => openHistoryModal(cat.code, 'TOTAL');

                card.innerHTML = `
                    <div class="absolute inset-0 flex flex-col items-center justify-center p-2">
                        <div class="text-center">
                            <div class="card-title text-sm whitespace-nowrap">${cat.label}</div>
                            <div class="text-xl font-extrabold mt-1 ${count > 0 ? 'text-red-600' : 'text-slate-500'}">
                                ${count}<span class="text-xs font-normal ml-1">ê±´</span>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        const SECTIONS = [
            { 
                id: "short", title: "Short SB", theme: "blue", 
                groups: [
                    { name: "GROUP 1 (7F)", desc: "Bottom Area", devices: [{no:3,pos:'left'},{no:2,pos:'left'},{no:1,pos:'left'},{no:10,pos:'top'},{no:11,pos:'top'},{no:12,pos:'top'},{no:9,pos:'right'},{no:8,pos:'right'},{no:7,pos:'right'},{no:6,pos:'bottom'},{no:5,pos:'bottom'},{no:4,pos:'bottom'}] },
                    { name: "GROUP 2 (7.5F)", desc: "Lower Area", devices: [{no:13,pos:'left'},{no:14,pos:'left'},{no:15,pos:'left'},{no:16,pos:'left'},{no:17,pos:'left'},{no:32,pos:'top'},{no:31,pos:'top'},{no:30,pos:'top'},{no:29,pos:'top'},{no:28,pos:'top'},{no:23,pos:'right'},{no:24,pos:'right'},{no:25,pos:'right'},{no:26,pos:'right'},{no:27,pos:'right'},{no:18,pos:'bottom'},{no:19,pos:'bottom'},{no:20,pos:'bottom'},{no:21,pos:'bottom'},{no:22,pos:'bottom'}] },
                    { name: "GROUP 3 (8F)", desc: "Middle Area", devices: [{no:37,pos:'left'},{no:36,pos:'left'},{no:35,pos:'left'},{no:34,pos:'left'},{no:33,pos:'left'},{no:48,pos:'top'},{no:49,pos:'top'},{no:50,pos:'top'},{no:51,pos:'top'},{no:52,pos:'top'},{no:47,pos:'right'},{no:46,pos:'right'},{no:45,pos:'right'},{no:44,pos:'right'},{no:43,pos:'right'},{no:42,pos:'bottom'},{no:41,pos:'bottom'},{no:40,pos:'bottom'},{no:39,pos:'bottom'},{no:38,pos:'bottom'}] },
                    { name: "GROUP 4 (8.5F)", desc: "Upper Area", devices: [{no:53,pos:'left'},{no:54,pos:'left'},{no:55,pos:'left'},{no:56,pos:'left'},{no:57,pos:'left'},{no:72,pos:'top'},{no:71,pos:'top'},{no:70,pos:'top'},{no:69,pos:'top'},{no:68,pos:'top'},{no:63,pos:'right'},{no:64,pos:'right'},{no:65,pos:'right'},{no:66,pos:'right'},{no:67,pos:'right'},{no:58,pos:'bottom'},{no:59,pos:'bottom'},{no:60,pos:'bottom'},{no:61,pos:'bottom'},{no:62,pos:'bottom'}] },
                    { name: "GROUP 4.5 (9F)", desc: "NS Series", devices: [{no:'NS1',pos:'left'},{no:'NS2',pos:'left'},{no:'NS3',pos:'left'},{no:'NS4',pos:'left'},{no:'NS20',pos:'top'},{no:'NS19',pos:'top'},{no:'NS18',pos:'top'},{no:'NS17',pos:'top'},{no:'NS16',pos:'top'},{no:'NS14',pos:'right'},{no:'NS13',pos:'right'},{no:'NS12',pos:'right'},{no:'NS11',pos:'right'},{no:'NS6',pos:'bottom'},{no:'NS7',pos:'bottom'},{no:'NS8',pos:'bottom'},{no:'NS9',pos:'bottom'},{no:'NS10',pos:'bottom'}] }
                ]
            },
            { 
                id: "long", title: "Long SB", theme: "red", 
                groups: [
                    { name: "GROUP 5 (10F)", desc: "Middle Section 1", devices: [{no:74,pos:'left'},{no:128,pos:'left'},{no:76,pos:'left'},{no:124,pos:'left'},{no:78,pos:'left'},{no:73,pos:'right'},{no:127,pos:'right'},{no:75,pos:'right'},{no:123,pos:'right'},{no:77,pos:'right'}] },
                    { name: "GROUP 5.5 (10.5F)", desc: "Middle Section 2", devices: [{no:86,pos:'left'},{no:84,pos:'left'},{no:'NL2',pos:'left'},{no:82,pos:'left'},{no:80,pos:'left'},{no:85,pos:'right'},{no:83,pos:'right'},{no:'NL1',pos:'right'},{no:81,pos:'right'},{no:79,pos:'right'}] },
                    { name: "GROUP 6 (11F)", desc: "Upper Middle", devices: [{no:88,pos:'left'},{no:90,pos:'left'},{no:92,pos:'left'},{no:94,pos:'left'},{no:96,pos:'left'},{no:87,pos:'right'},{no:89,pos:'right'},{no:91,pos:'right'},{no:93,pos:'right'},{no:95,pos:'right'}] },
                    { name: "GROUP 7 (12F)", desc: "Upper Section", devices: [{no:104,pos:'left'},{no:102,pos:'left'},{no:'NL4',pos:'left'},{no:100,pos:'left'},{no:98,pos:'left'},{no:103,pos:'right'},{no:101,pos:'right'},{no:'NL3',pos:'right'},{no:99,pos:'right'},{no:97,pos:'right'}] },
                    { name: "GROUP 8 (13F)", desc: "High Section 1", devices: [{no:106,pos:'left'},{no:108,pos:'left'},{no:110,pos:'left'},{no:112,pos:'left'},{no:'NL6',pos:'left'},{no:105,pos:'right'},{no:107,pos:'right'},{no:109,pos:'right'},{no:111,pos:'right'},{no:'NL5',pos:'right'}] },
                    { name: "GROUP 8.5 (14F)", desc: "High Section 2", devices: [{no:122,pos:'left'},{no:120,pos:'left'},{no:118,pos:'left'},{no:116,pos:'left'},{no:114,pos:'left'},{no:121,pos:'right'},{no:119,pos:'right'},{no:117,pos:'right'},{no:115,pos:'right'},{no:113,pos:'right'}] },
                    { name: "GROUP 9 (ECO - 12F)", desc: "Economizer Lower", devices: [{no:130,pos:'left'},{no:132,pos:'left'},{no:134,pos:'left'},{no:129,pos:'right'},{no:131,pos:'right'},{no:133,pos:'right'}] },
                    { name: "GROUP 9.5 (ECO - 13F)", desc: "Economizer Upper", devices: [{no:'NL8',pos:'left'},{no:126,pos:'left'},{no:'NL10',pos:'left'},{no:'NL7',pos:'right'},{no:125,pos:'right'},{no:'NL9',pos:'right'}] }
                ]
            }
        ];

        function showAlert(message) {
            const toast = document.getElementById('toastMessage');
            toast.textContent = message;
            toast.classList.remove('hidden');
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        function initDashboard() {
            document.getElementById('page-unit-selection').classList.add('active');
            fetchTotalSummary(); 
        }

        function selectUnit(unitName) {
            currentUnit = unitName;
            document.getElementById('headerUnitTitle').textContent = `#${unitName.split(' ')[1]}í˜¸ê¸° ê·¸ë£¹ ì„ íƒ`;
            SECTIONS.forEach(section => {
                const listEl = document.getElementById(section.id === 'short' ? 'list-short' : 'list-long');
                listEl.innerHTML = '';
                section.groups.forEach((group, idx) => {
                    const btn = document.createElement('div');
                    const barColor = section.theme === 'blue' ? 'blue' : 'red';
                    btn.className = `dashboard-card ${barColor}`;
                    btn.innerHTML = `<div class="card-title">${group.name}</div>`;
                    btn.onclick = () => showDetail(section.id, idx);
                    listEl.appendChild(btn);
                });
            });
            document.getElementById('page-unit-selection').classList.remove('active');
            document.getElementById('page-group-selection').classList.add('active');
        }

        function goUnitSelection() {
            document.getElementById('page-group-selection').classList.remove('active');
            document.getElementById('page-unit-selection').classList.add('active');
            currentUnit = null;
            fetchTotalSummary(); 
        }

        function goGroupSelection() { 
            document.getElementById('page-detail').classList.remove('active'); 
            document.getElementById('page-group-selection').classList.add('active');
            document.getElementById('memoInput').value = '';
        }

        function showDetail(sectionId, groupIdx) {
            const section = SECTIONS.find(s => s.id === sectionId);
            const group = section.groups[groupIdx];
            const fullGroupName = `${currentUnit} - ${group.name}`;
            currentSelection.group = fullGroupName;
            document.getElementById('detail-title').textContent = group.name;
            const descEl = document.getElementById('detail-desc');
            descEl.textContent = currentUnit + ' ' + group.desc;
            descEl.classList.remove('hidden');

            ['top', 'bottom', 'left', 'right'].forEach(pos => {
                const el = document.getElementById(`area-${pos}`);
                if (el) el.innerHTML = '';
            });

            document.getElementById('centerBox').innerHTML = `
                <div class="text-[10px] text-center font-bold text-slate-400 border-b border-slate-200 pb-1 mb-1">ì •ë¹„ í˜„í™©</div>
                <div id="statusList" class="flex-1 overflow-y-auto flex flex-col gap-1">
                    <div class="flex items-center justify-center h-full text-slate-300 text-xs"><div class="animate-spin mr-2 rounded-full border-2 border-slate-300 border-t-slate-500 h-4 w-4"></div>ë¡œë”© ì¤‘...</div>
                </div>`;

            group.devices.forEach(device => {
                const btn = document.createElement('div');
                btn.className = 'device-btn';
                let content = '';
                const strNo = String(device.no);
                if (strNo.startsWith('NS') || strNo.startsWith('NL')) {
                    const type = strNo.substring(0,2); const num = strNo.substring(2);
                    content = `<span class="label-sm">${type}</span><span class="label-lg">${num}</span>`;
                } else { content = `<span class="label-lg">${strNo}</span>`; }
                btn.innerHTML = content;
                btn.onclick = () => openModal(group.name, device.no);
                if (document.getElementById(`area-${device.pos}`)) {
                    document.getElementById(`area-${device.pos}`).appendChild(btn);
                }
            });

            fetchGroupData(fullGroupName);
            document.getElementById('page-group-selection').classList.remove('active');
            document.getElementById('page-detail').classList.add('active');
            window.scrollTo(0,0);
        }

        function fetchGroupData(fullGroupName) {
            if(GOOGLE_SCRIPT_URL.includes("ì—¬ê¸°ì—")) {
                const sl = document.getElementById('statusList');
                if(sl) sl.innerHTML = `<div class="text-center text-xs text-red-400 mt-4">URL ë¯¸ì„¤ì •</div>`;
                return;
            }
            
            const separator = GOOGLE_SCRIPT_URL.includes('?') ? '&' : '?';
            const url = `${GOOGLE_SCRIPT_URL}${separator}group=${encodeURIComponent(fullGroupName)}&t=${new Date().getTime()}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    let finalData = data;
                    if (!Array.isArray(data)) {
                        if (data.result && Array.isArray(data.result)) finalData = data.result;
                        else if (data.data && Array.isArray(data.data)) finalData = data.data;
                        else finalData = [];
                    }
                    currentGroupData = finalData;
                    updateCenterStatus(finalData);
                })
                .catch(err => {
                    console.error(err);
                    const sl = document.getElementById('statusList');
                    if(sl) sl.innerHTML = `<div class="text-center text-xs text-slate-400 mt-4">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>`;
                });
        }

        function updateCenterStatus(data) {
            const counts = {};
            STATUS_CATEGORIES.forEach(cat => counts[cat.code] = 0);
            data.forEach(item => {
                let code;
                if (item.device === 'NOTE') { code = 'NOTE'; } 
                else { code = getCategoryByAction(item.action); }
                if (counts[code] !== undefined) counts[code]++;
            });
            let html = `
                <div class="text-[10px] text-center font-bold text-slate-400 border-b border-slate-200 pb-1 mb-1">ì •ë¹„ í˜„í™©</div>
                <div id="statusListContent" class="flex-1 overflow-y-auto flex flex-col gap-1">`;
            STATUS_CATEGORIES.forEach((cat, idx) => {
                const count = counts[cat.code] || 0;
                const activeClass = count > 0 ? 'active' : '';
                html += `<div class="status-row ${activeClass}" onclick="openHistoryModal('${cat.code}', 'GROUP')"><span>${idx+1}. ${cat.label}</span><span class="badge ${activeClass}">${count}ê±´</span></div>`;
            });
            html += `</div>`;
            const centerBox = document.getElementById('centerBox');
            if(centerBox) centerBox.innerHTML = html;
            const memoCount = counts['NOTE'] || 0;
            const memoBadge = document.getElementById('memoCountBadge');
            if (memoBadge) {
                memoBadge.textContent = `${memoCount}ê±´`;
                if (memoCount > 0) { memoBadge.classList.add('active'); } else { memoBadge.classList.remove('active'); }
            }
        }

        function openHistoryModal(code, scope = 'GROUP') {
            const cat = STATUS_CATEGORIES.find(c => c.code === code);
            document.getElementById('historyTitle').textContent = `[${cat.label}] ${scope === 'TOTAL' ? 'ì „ì²´' : 'ê·¸ë£¹'} ì´ë ¥`;
            
            const tbody = document.getElementById('historyListBody');
            const noMsg = document.getElementById('noHistoryMsg');
            tbody.innerHTML = '';
            
            const sourceData = scope === 'TOTAL' ? totalDataRecords : currentGroupData;

            let filtered;
            if (code === 'NOTE') { 
                filtered = sourceData.filter(d => d.device === 'NOTE'); 
            } else { 
                filtered = sourceData.filter(d => d.device !== 'NOTE' && getCategoryByAction(d.action) === code); 
            }
            
            if(filtered.length === 0) { noMsg.classList.remove('hidden'); } 
            else {
                noMsg.classList.add('hidden');
                filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
                filtered.forEach(item => {
                    const dateDisplay = item.date.substring(5); // MM-DD
                    let deviceLocationDisplay;

                    if (scope === 'TOTAL') {
                         const unitName = item.group.split(' - ')[0].split(' ')[1]; 
                         const groupName = item.group.split(' - ')[1]; 
                         const deviceNum = item.device === 'NOTE' ? 'ë©”ëª¨' : `No.${item.device}`;

                         deviceLocationDisplay = `#${unitName}í˜¸ê¸° - ${groupName} (${deviceNum})`;
                    } else {
                        deviceLocationDisplay = item.device === 'NOTE' ? 'ë©”ëª¨' : `No.${item.device}`;
                    }

                    const actionDisplay = item.action;

                    tbody.innerHTML += `<tr>
                        <td class="px-4 py-3 font-medium text-slate-900 whitespace-nowrap">${dateDisplay}</td>
                        <td class="px-2 py-3 font-bold text-blue-600">${deviceLocationDisplay}</td>
                        <td class="px-4 py-3 text-slate-500">${actionDisplay}</td>
                    </tr>`;
                });
            }
            
            const modal = document.getElementById('historyModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('flex'), 10);
        }

        function openModal(g, d) { 
            currentSelection = { group: currentSelection.group, deviceNo: d }; 
            const displayGroup = currentSelection.group.split(' - ')[1] || currentSelection.group; 
            document.getElementById('modalTitle').textContent = `No. ${d}`; 
            document.getElementById('modalSubtitle').textContent = displayGroup; 
            document.getElementById('actionModal').classList.remove('hidden'); 
            setTimeout(() => document.getElementById('actionModal').classList.add('flex'), 10); 
        }
        function closeModal(id) { 
            const modal = document.getElementById(id); 
            modal.classList.remove('flex'); 
            setTimeout(() => modal.classList.add('hidden'), 200); 
        }
        
        // Optimistic Update Implementation
        function optimisticUpdate(group, deviceNo, action) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            
            const newRecord = {
                date: dateStr,
                group: group,
                device: deviceNo,
                action: action
            };
            
            totalDataRecords.push(newRecord);
            currentGroupData.push(newRecord);
            totalCounts = calculateTotalCounts(totalDataRecords);
            
            renderTotalDashboard();
            
            if (document.getElementById('page-detail').classList.contains('active')) {
                updateCenterStatus(currentGroupData);
            }
        }

        function submitAction(action) {
            if(!currentSelection.group) return;
            const loading = document.getElementById('loadingOverlay');
            loading.classList.remove('hidden'); loading.classList.add('flex');
            closeModal('actionModal');
            
            optimisticUpdate(currentSelection.group, currentSelection.deviceNo, action);
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST", mode: "no-cors",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({group: currentSelection.group, deviceNo: currentSelection.deviceNo, action: action})
            }).then(() => { 
                loading.classList.add('hidden'); loading.classList.remove('flex'); 
                showAlert(`[${currentUnit} - ${currentSelection.deviceNo} - ${action}] ì €ì¥ ì™„ë£Œ!`); 
                
                setTimeout(() => {
                    fetchGroupData(currentSelection.group);
                    fetchTotalSummary(); 
                }, 1000); 
            }).catch(() => { 
                loading.classList.add('hidden'); loading.classList.remove('flex'); 
                showAlert("ì „ì†¡ ì‹¤íŒ¨ (í™”ë©´ì—” ë°˜ì˜ë¨)"); 
            });
        }

        function submitMemo() {
            const memoText = document.getElementById('memoInput').value;
            if(!memoText.trim()) { showAlert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            if(!currentSelection.group) { showAlert("ê·¸ë£¹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
            
            const loading = document.getElementById('loadingOverlay');
            loading.classList.remove('hidden'); loading.classList.add('flex');
            
            optimisticUpdate(currentSelection.group, 'NOTE', memoText);
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST", mode: "no-cors",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ group: currentSelection.group, deviceNo: 'NOTE', action: memoText })
            }).then(() => { 
                loading.classList.add('hidden'); loading.classList.remove('flex'); 
                showAlert("íŠ¹ì´ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                document.getElementById('memoInput').value = ''; 
                
                setTimeout(() => {
                    fetchGroupData(currentSelection.group); 
                    fetchTotalSummary();
                }, 1000);
            }).catch(() => { 
                loading.classList.add('hidden'); loading.classList.remove('flex'); 
                showAlert("ì €ì¥ ì‹¤íŒ¨ (í™”ë©´ì—” ë°˜ì˜ë¨)"); 
            });
        }

        initDashboard();
    </script>
</body>
</html>