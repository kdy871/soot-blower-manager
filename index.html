<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soot Blower ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- í°íŠ¸: í”„ë¦¬í…ë‹¤ë“œ (ê¹”ë”í•œ ê³ ë”•) -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* í™”ë©´ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
        .page-section { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .page-section.active { display: block; opacity: 1; }

        /* =========================================
           1. ë©”ì¸ ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼ (ìµœì¢… í™•ì •)
           ========================================= */
        .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .dashboard-card {
            background: white; border-radius: 16px; padding: 24px 16px; text-align: center; border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer; position: relative; overflow: hidden;
        }
        .dashboard-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #cbd5e1; }
        .dashboard-card:active { transform: scale(0.98); }
        .card-title { font-size: 16px; font-weight: 700; color: #1e293b; letter-spacing: -0.5px; }
        .card-bar { position: absolute; top: 0; left: 0; width: 100%; height: 4px; }
        .bar-blue { background-color: #3b82f6; }
        .bar-red { background-color: #ef4444; }

        /* =========================================
           2. ìƒì„¸ í™”ë©´ ìŠ¤íƒ€ì¼ (ìµœì¢… í™•ì •)
           ========================================= */
        .boiler-container {
            background: white; border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 30px; position: relative; aspect-ratio: 1 / 1; max-width: 500px; margin: 0 auto; border: 1px solid #f1f5f9;
        }
        .boiler-grid { display: grid; grid-template-columns: 60px 1fr 60px; grid-template-rows: 60px 1fr 60px; height: 100%; gap: 10px; position: relative; z-index: 10; }
        .corner-number { position: absolute; font-weight: 900; font-size: 3.5rem; color: #ffe4e6; line-height: 1; z-index: 0; user-select: none; }
        .cn-1 { bottom: 15px; left: 20px; } .cn-2 { top: 15px; left: 20px; } .cn-3 { top: 15px; right: 20px; } .cn-4 { bottom: 15px; right: 20px; }
        .center-status-box {
            grid-column: 2 / 3; grid-row: 2 / 3; border: 2px dashed #cbd5e1; border-radius: 12px;
            background-color: #f8fafc; display: flex; flex-direction: column; padding: 10px; overflow: hidden;
        }
        .device-btn {
            width: 48px; height: 48px; background: white; border: 1.5px solid #475569; border-radius: 8px;
            color: #1e293b; font-weight: 700; font-size: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.15s ease; cursor: pointer; z-index: 20;
        }
        .device-btn:active { transform: scale(0.92); background-color: #f1f5f9; }
        .device-btn:hover { border-color: #2563eb; color: #2563eb; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15); }
        .label-sm { font-size: 10px; line-height: 1; color: #64748b; margin-bottom: 2px; }
        .label-lg { font-size: 16px; line-height: 1; }
        .side-container { display: flex; align-items: center; justify-content: space-evenly; width: 100%; height: 100%; }
        .side-top { grid-column: 2/3; grid-row: 1/2; flex-direction: row; align-items: flex-end; padding-bottom: 8px; }
        .side-bottom { grid-column: 2/3; grid-row: 3/4; flex-direction: row; align-items: flex-start; padding-top: 8px; }
        .side-left { grid-column: 1/2; grid-row: 2/3; flex-direction: column; align-items: flex-end; padding-right: 8px; }
        .side-right { grid-column: 3/4; grid-row: 2/3; flex-direction: column; align-items: flex-start; padding-left: 8px; }
        .status-row {
            display: flex; justify-content: space-between; align-items: center; padding: 6px 8px; border-radius: 6px; font-size: 11px;
            font-weight: 600; color: #475569; cursor: pointer; border-bottom: 1px solid #f1f5f9;
        }
        .status-row:last-child { border-bottom: none; }
        .status-row:hover { background-color: #e0f2fe; color: #0369a1; }
        .badge { background: #e2e8f0; color: #64748b; padding: 2px 6px; border-radius: 99px; font-size: 10px; }
        .badge.active { background: #ef4444; color: white; }

        /* 3. ë©”ëª¨ì¥ ìŠ¤íƒ€ì¼ */
        .memo-container {
            margin-top: 20px; background-color: white; border-radius: 16px; padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0;
        }
        .memo-input {
            width: 100%; border: 1px solid #cbd5e1; border-radius: 12px; padding: 12px; font-size: 14px;
            resize: none; height: 80px; background-color: #f8fafc; transition: all 0.2s;
        }
        .memo-input:focus { outline: none; border-color: #3b82f6; background-color: white; }
        .memo-btn {
            margin-top: 10px; width: 100%; background-color: #334155; color: white; padding: 12px;
            border-radius: 12px; font-weight: bold; font-size: 14px; transition: background 0.2s;
        }
        .memo-btn:active { transform: scale(0.98); }
        .memo-btn:hover { background-color: #1e293b; }
        
        /* â˜…â˜…â˜… [ì‹ ê·œ] ì¢…í•© ë©”ëª¨ ë²„íŠ¼ ìŠ¤íƒ€ì¼ â˜…â˜…â˜… */
        .memo-summary-btn {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; padding: 12px 15px; border-radius: 12px; background-color: #f1f5f9;
            border: 1px solid #e2e8f0; margin-top: 10px; font-weight: 700; font-size: 13px;
            color: #475569; cursor: pointer; transition: all 0.2s;
        }
        .memo-summary-btn:hover { background-color: #e2e8f0; color: #1e293b; }
        .memo-count-badge { background-color: #94a3b8; color: white; padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: 800; }
        .memo-count-badge.active { background-color: #ef4444; }

    </style>
</head>
<body class="max-w-md mx-auto min-h-screen flex flex-col">

    <!-- ================= PAGE 1: ë©”ì¸ ëŒ€ì‹œë³´ë“œ ================= -->
    <div id="page-dashboard" class="page-section active p-5">
        <header class="mb-8 mt-4 text-center">
            <h1 class="text-2xl font-extrabold text-slate-800 tracking-tight">Soot Blower <span class="text-blue-600">Manager</span></h1>
            <p class="text-slate-400 text-xs mt-1 font-medium">ê´€ë¦¬í•  ì„¤ë¹„ êµ¬ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
        </header>

        <!-- Short Section -->
        <div class="mb-10">
            <div class="flex items-center mb-4">
                <div class="w-1 h-4 bg-blue-500 rounded-full mr-2"></div>
                <h2 class="text-xs font-bold text-blue-600 uppercase tracking-widest">Short Blower (G1-G4.5)</h2>
            </div>
            <div id="list-short" class="dashboard-grid"></div>
        </div>

        <!-- Long Section -->
        <div>
            <div class="flex items-center mb-4">
                <div class="w-1 h-4 bg-red-500 rounded-full mr-2"></div>
                <h2 class="text-xs font-bold text-red-600 uppercase tracking-widest">Long Blower (G5-G9)</h2>
            </div>
            <div id="list-long" class="dashboard-grid"></div>
        </div>
    </div>

    <!-- ================= PAGE 2: ìƒì„¸ í™”ë©´ ================= -->
    <div id="page-detail" class="page-section p-4 h-screen flex flex-col pb-10 overflow-y-auto">
        <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="flex justify-between items-center mb-6 px-2">
            <button onclick="goHome()" class="flex items-center text-slate-500 hover:text-slate-800 font-bold text-sm transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                ë’¤ë¡œê°€ê¸°
            </button>
            <div class="text-right">
                <h2 id="detail-title" class="font-extrabold text-xl text-slate-800 tracking-tight">GROUP 1</h2>
                <p id="detail-desc" class="text-[10px] text-slate-400 font-bold uppercase tracking-wide hidden"></p>
            </div>
        </div>

        <!-- ë©”ì¸ ë³´ì¼ëŸ¬ ì»¨í…Œì´ë„ˆ -->
        <div class="flex-none flex items-center justify-center">
            <div class="boiler-container w-full">
                <!-- ë°°ê²½ ì½”ë„ˆ ìˆ«ì -->
                <div class="corner-number cn-1">1</div>
                <div class="corner-number cn-2">2</div>
                <div class="corner-number cn-3">3</div>
                <div class="corner-number cn-4">4</div>

                <!-- ê·¸ë¦¬ë“œ -->
                <div class="boiler-grid">
                    <!-- ì¤‘ì•™ ìƒíƒœì°½ -->
                    <div class="center-status-box" id="centerBox">
                        <div class="text-[10px] text-center font-bold text-slate-400 border-b border-slate-200 pb-1 mb-1">ì •ë¹„ í˜„í™©</div>
                        <div id="statusList" class="flex-1 overflow-y-auto flex flex-col gap-1">
                            <!-- JSë¡œ ì±„ì›Œì§ -->
                            <div class="flex items-center justify-center h-full text-slate-300 text-xs">Loading...</div>
                        </div>
                    </div>
                    
                    <!-- ê¸°ê¸° ë²„íŠ¼ë“¤ì´ ë“¤ì–´ê°ˆ ì˜ì—­ (JSë¡œ ìƒì„±) -->
                    <div id="area-top" class="side-container side-top"></div>
                    <div id="area-bottom" class="side-container side-bottom"></div>
                    <div id="area-left" class="side-container side-left"></div>
                    <div id="area-right" class="side-container side-right"></div>
                </div>
            </div>
        </div>

        <!-- íŠ¹ì´ì‚¬í•­ ë©”ëª¨ì¥ -->
        <div class="memo-container">
            <h3 class="text-sm font-bold text-slate-600 mb-2 flex items-center">
                <span class="mr-2">ğŸ“</span> í˜„ì¥ íŠ¹ì´ì‚¬í•­ / í”¼ë“œë°± ë©”ëª¨
            </h3>
            <textarea id="memoInput" class="memo-input" placeholder="ì˜ˆ) 3ë²ˆ ê¸°ê¸° ì†ŒìŒ ë°œìƒ, ë¹„ê³„ ì„¤ì¹˜ í•„ìš” ë“± íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
            <button onclick="submitMemo()" class="memo-btn">ë©”ëª¨ ì €ì¥í•˜ê¸°</button>
            
            <!-- â˜…â˜…â˜… [ì‹ ê·œ] íŠ¹ì´ì‚¬í•­ ì¢…í•© ë‚´ìš© ë²„íŠ¼ â˜…â˜…â˜… -->
            <button id="memoSummaryButton" onclick="openHistoryModal('NOTE')" class="memo-summary-btn">
                <span>íŠ¹ì´ì‚¬í•­ ì¢…í•© ë‚´ìš© ë° í™•ì¸</span>
                <span id="memoCountBadge" class="memo-count-badge">0ê±´</span>
            </button>
        </div>
        
        <!-- í•˜ë‹¨ ì—¬ë°± -->
        <div class="h-10"></div>
    </div>

    <!-- ================= ì‘ì—… ì…ë ¥ ëª¨ë‹¬ ================= -->
    <div id="actionModal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 p-4 backdrop-blur-[2px] transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs overflow-hidden transform scale-100 transition-transform">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-lg" id="modalTitle">No. 00</h3>
                    <p class="text-slate-400 text-xs" id="modalSubtitle">Group Name</p>
                </div>
                <span class="bg-blue-500 text-[10px] font-bold px-2 py-1 rounded">ì‘ì—… ì„ íƒ</span>
            </div>
            <div class="p-4 grid grid-cols-1 gap-2">
                <button onclick="submitAction('ì¼€ì´ë¸” êµì²´')" class="w-full p-3 border rounded-xl hover:bg-blue-50 hover:border-blue-500 hover:text-blue-700 font-bold text-slate-600 text-sm transition-all text-left flex items-center">
                    <span class="w-6 text-center mr-2">ğŸ”Œ</span> 1. ì¼€ì´ë¸” êµì²´
                </button>
                <button onclick="submitAction('ì „ë™ê¸° ì†Œì†')" class="w-full p-3 border rounded-xl hover:bg-red-50 hover:border-red-500 hover:text-red-700 font-bold text-slate-600 text-sm transition-all text-left flex items-center">
                    <span class="w-6 text-center mr-2">ğŸ”¥</span> 2. ì „ë™ê¸° ì†Œì†
                </button>
                <button onclick="submitAction('ì „ë™ê¸° ë² ì–´ë§ êµì²´')" class="w-full p-3 border rounded-xl hover:bg-orange-50 hover:border-orange-500 hover:text-orange-700 font-bold text-slate-600 text-sm transition-all text-left flex items-center">
                    <span class="w-6 text-center mr-2">âš™ï¸</span> 3. ë² ì–´ë§ êµì²´
                </button>
                <button onclick="submitAction('ì „ë™ê¸° ì—­ìƒ')" class="w-full p-3 border rounded-xl hover:bg-yellow-50 hover:border-yellow-500 hover:text-yellow-700 font-bold text-slate-600 text-sm transition-all text-left flex items-center">
                    <span class="w-6 text-center mr-2">âš ï¸</span> 4. ì „ë™ê¸° ì—­ìƒ
                </button>
                <button onclick="submitAction('ë¦¬ë¯¸íŠ¸ ì¡°ì • [íšŒë¡œ]')" class="w-full p-3 border rounded-xl hover:bg-green-50 hover:border-green-500 hover:text-green-700 font-bold text-slate-600 text-sm transition-all text-left flex items-center">
                    <span class="w-6 text-center mr-2">âš¡</span> 5. ë¦¬ë¯¸íŠ¸ ì¡°ì • [íšŒë¡œ]
                </button>
                <button onclick="submitAction('ê¸°ê³„ì  ê³ ì°© [ê¸°ê³„]')" class="w-full p-3 border rounded-xl hover:bg-purple-50 hover:border-purple-500 hover:text-purple-700 font-bold text-slate-600 text-sm transition-all text-left flex items-center">
                    <span class="w-6 text-center mr-2">ğŸ”§</span> 6. ê¸°ê³„ì  ê³ ì°© [ê¸°ê³„]
                </button>
            </div>
            <div class="bg-slate-50 p-3 text-center border-t cursor-pointer hover:bg-slate-100 transition-colors" onclick="closeModal('actionModal')">
                <span class="text-slate-500 font-bold text-sm">ë‹«ê¸°</span>
            </div>
        </div>
    </div>

    <!-- ================= ì´ë ¥ í™•ì¸ ëª¨ë‹¬ ================= -->
    <div id="historyModal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-[60] p-4 backdrop-blur-[2px]">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm h-3/4 flex flex-col overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-white sticky top-0">
                <h3 class="font-bold text-lg text-slate-800" id="historyTitle">ì´ë ¥</h3>
                <button onclick="closeModal('historyModal')" class="text-slate-400 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-0 bg-slate-50">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-100 sticky top-0">
                        <tr><th class="px-4 py-3">ë‚ ì§œ</th><th class="px-2 py-3">ê¸°ê¸°</th><th class="px-4 py-3">ë‚´ìš©</th></tr>
                    </thead>
                    <tbody id="historyListBody" class="text-slate-700 divide-y divide-slate-200 bg-white"></tbody>
                </table>
                <div id="noHistoryMsg" class="hidden p-10 text-center text-slate-400 text-sm">ê¸°ë¡ëœ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
    <div id="loadingOverlay" class="fixed inset-0 hidden items-center justify-center z-[70] bg-white/80 backdrop-blur-sm">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-3"></div>
            <span class="font-bold text-slate-600 animate-pulse">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</span>
        </div>
    </div>

    <script>
        // â˜…â˜…â˜…â˜…â˜… [í•„ìˆ˜] ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ URL ì…ë ¥ â˜…â˜…â˜…â˜…â˜…
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwyJgKM4gfPmd3qHx7XuuazUENcOKMvQ_oBZ_6HpVOzV1WeHYMjbglkxSQ_pMB2BRno/exec";

        // ë¶„ë¥˜ ì¹´í…Œê³ ë¦¬ ì •ì˜
        const STATUS_CATEGORIES = [
            { code: 'C', label: 'ì¼€ì´ë¸” êµì²´' }, 
            { code: 'MB', label: 'ì „ë™ê¸° ì†Œì†' },
            { code: 'BR', label: 'ë² ì–´ë§ êµì²´' }, 
            { code: 'RP', label: 'ì „ë™ê¸° ì—­ìƒ' },
            { code: 'LA', label: 'ë¦¬ë¯¸íŠ¸ ì¡°ì •' }, 
            { code: 'MS', label: 'ê¸°ê³„ì  ê³ ì°©' },
            { code: 'NOTE', label: 'íŠ¹ì´ì‚¬í•­ ë©”ëª¨' } // â˜…â˜…â˜… [ìˆ˜ì •] ë©”ëª¨ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ â˜…â˜…â˜…
        ];

        function getCategoryByAction(action) {
            if (action === 'ì¼€ì´ë¸” êµì²´') return 'C';
            if (action === 'ì „ë™ê¸° ì†Œì†') return 'MB';
            if (action === 'ì „ë™ê¸° ë² ì–´ë§ êµì²´') return 'BR';
            if (action === 'ì „ë™ê¸° ì—­ìƒ') return 'RP';
            if (action === 'ë¦¬ë¯¸íŠ¸ ì¡°ì • [íšŒë¡œ]') return 'LA';
            if (action === 'ê¸°ê³„ì  ê³ ì°© [ê¸°ê³„]') return 'MS';
            
            return 'ETC';
        }

        const SECTIONS = [
            { 
                id: "short", title: "Short SB", theme: "blue", 
                groups: [
                    { name: "GROUP 1 (7F)", desc: "Bottom Area", devices: [{no:3,pos:'left'},{no:2,pos:'left'},{no:1,pos:'left'},{no:10,pos:'top'},{no:11,pos:'top'},{no:12,pos:'top'},{no:9,pos:'right'},{no:8,pos:'right'},{no:7,pos:'right'},{no:6,pos:'bottom'},{no:5,pos:'bottom'},{no:4,pos:'bottom'}] },
                    { name: "GROUP 2 (7.5F)", desc: "Lower Area", devices: [{no:13,pos:'left'},{no:14,pos:'left'},{no:15,pos:'left'},{no:16,pos:'left'},{no:17,pos:'left'},{no:32,pos:'top'},{no:31,pos:'top'},{no:30,pos:'top'},{no:29,pos:'top'},{no:28,pos:'top'},{no:23,pos:'right'},{no:24,pos:'right'},{no:25,pos:'right'},{no:26,pos:'right'},{no:27,pos:'right'},{no:18,pos:'bottom'},{no:19,pos:'bottom'},{no:20,pos:'bottom'},{no:21,pos:'bottom'},{no:22,pos:'bottom'}] },
                    { name: "GROUP 3 (8F)", desc: "Middle Area", devices: [{no:37,pos:'left'},{no:36,pos:'left'},{no:35,pos:'left'},{no:34,pos:'left'},{no:33,pos:'left'},{no:48,pos:'top'},{no:49,pos:'top'},{no:50,pos:'top'},{no:51,pos:'top'},{no:52,pos:'top'},{no:47,pos:'right'},{no:46,pos:'right'},{no:45,pos:'right'},{no:44,pos:'right'},{no:43,pos:'right'},{no:42,pos:'bottom'},{no:41,pos:'bottom'},{no:40,pos:'bottom'},{no:39,pos:'bottom'},{no:38,pos:'bottom'}] },
                    { name: "GROUP 4 (8.5F)", desc: "Upper Area", devices: [{no:53,pos:'left'},{no:54,pos:'left'},{no:55,pos:'left'},{no:56,pos:'left'},{no:57,pos:'left'},{no:72,pos:'top'},{no:71,pos:'top'},{no:70,pos:'top'},{no:69,pos:'top'},{no:68,pos:'top'},{no:63,pos:'right'},{no:64,pos:'right'},{no:65,pos:'right'},{no:66,pos:'right'},{no:67,pos:'right'},{no:58,pos:'bottom'},{no:59,pos:'bottom'},{no:60,pos:'bottom'},{no:61,pos:'bottom'},{no:62,pos:'bottom'}] },
                    { name: "GROUP 4.5 (9F)", desc: "NS Series", devices: [{no:'NS1',pos:'left'},{no:'NS2',pos:'left'},{no:'NS3',pos:'left'},{no:'NS4',pos:'left'},{no:'NS20',pos:'top'},{no:'NS19',pos:'top'},{no:'NS18',pos:'top'},{no:'NS17',pos:'top'},{no:'NS16',pos:'top'},{no:'NS14',pos:'right'},{no:'NS13',pos:'right'},{no:'NS12',pos:'right'},{no:'NS11',pos:'right'},{no:'NS6',pos:'bottom'},{no:'NS7',pos:'bottom'},{no:'NS8',pos:'bottom'},{no:'NS9',pos:'bottom'},{no:'NS10',pos:'bottom'}] }
                ]
            },
            { 
                id: "long", title: "Long SB", theme: "red", 
                groups: [
                    { name: "GROUP 5 (10F)", desc: "Middle Section 1", devices: [{no:74,pos:'left'},{no:128,pos:'left'},{no:76,pos:'left'},{no:124,pos:'left'},{no:78,pos:'left'},{no:73,pos:'right'},{no:127,pos:'right'},{no:75,pos:'right'},{no:123,pos:'right'},{no:77,pos:'right'}] },
                    { name: "GROUP 5.5 (10.5F)", desc: "Middle Section 2", devices: [{no:86,pos:'left'},{no:84,pos:'left'},{no:'NL2',pos:'left'},{no:82,pos:'left'},{no:80,pos:'left'},{no:85,pos:'right'},{no:83,pos:'right'},{no:'NL1',pos:'right'},{no:81,pos:'right'},{no:79,pos:'right'}] },
                    { name: "GROUP 6 (11F)", desc: "Upper Middle", devices: [{no:88,pos:'left'},{no:90,pos:'left'},{no:92,pos:'left'},{no:94,pos:'left'},{no:96,pos:'left'},{no:87,pos:'right'},{no:89,pos:'right'},{no:91,pos:'right'},{no:93,pos:'right'},{no:95,pos:'right'}] },
                    { name: "GROUP 7 (12F)", desc: "Upper Section", devices: [{no:104,pos:'left'},{no:102,pos:'left'},{no:'NL4',pos:'left'},{no:100,pos:'left'},{no:98,pos:'left'},{no:103,pos:'right'},{no:101,pos:'right'},{no:'NL3',pos:'right'},{no:99,pos:'right'},{no:97,pos:'right'}] },
                    { name: "GROUP 8 (13F)", desc: "High Section 1", devices: [{no:106,pos:'left'},{no:108,pos:'left'},{no:110,pos:'left'},{no:112,pos:'left'},{no:'NL6',pos:'left'},{no:105,pos:'right'},{no:107,pos:'right'},{no:109,pos:'right'},{no:111,pos:'right'},{no:'NL5',pos:'right'}] },
                    { name: "GROUP 8.5 (14F)", desc: "High Section 2", devices: [{no:122,pos:'left'},{no:120,pos:'left'},{no:118,pos:'left'},{no:116,pos:'left'},{no:114,pos:'left'},{no:121,pos:'right'},{no:119,pos:'right'},{no:117,pos:'right'},{no:115,pos:'right'},{no:113,pos:'right'}] },
                    { name: "GROUP 9 (ECO - 12F)", desc: "Economizer Lower", devices: [{no:130,pos:'left'},{no:132,pos:'left'},{no:134,pos:'left'},{no:129,pos:'right'},{no:131,pos:'right'},{no:133,pos:'right'}] },
                    { name: "GROUP 9.5 (ECO - 13F)", desc: "Economizer Upper", devices: [{no:'NL8',pos:'left'},{no:126,pos:'left'},{no:'NL10',pos:'left'},{no:'NL7',pos:'right'},{no:125,pos:'right'},{no:'NL9',pos:'right'}] }
                ]
            }
        ];

        let currentSelection = { group: null, deviceNo: null };
        let currentGroupData = [];

        // ëŒ€ì‹œë³´ë“œ ë Œë”ë§
        function initDashboard() {
            SECTIONS.forEach(section => {
                const listEl = document.getElementById(section.id === 'short' ? 'list-short' : 'list-long');
                section.groups.forEach((group, idx) => {
                    const btn = document.createElement('div');
                    const barColor = section.theme === 'blue' ? 'bar-blue' : 'bar-red';
                    
                    btn.className = 'dashboard-card';
                    btn.innerHTML = `<div class="card-bar ${barColor}"></div><div class="card-title">${group.name}</div>`;
                    btn.onclick = () => showDetail(section.id, idx);
                    listEl.appendChild(btn);
                });
            });
        }

        // ìƒì„¸ í™”ë©´ ë Œë”ë§
        function showDetail(sectionId, groupIdx) {
            const section = SECTIONS.find(s => s.id === sectionId);
            const group = section.groups[groupIdx];
            
            // â˜…â˜…â˜… [ì¤‘ìš”] íŠ¹ì´ì‚¬í•­ ë©”ëª¨ë¥¼ ìœ„í•´ í˜„ì¬ ê·¸ë£¹ ì •ë³´ ì €ì¥ â˜…â˜…â˜…
            currentSelection.group = group.name;

            document.getElementById('detail-title').textContent = group.name;
            document.getElementById('detail-desc').textContent = group.desc;
            
            // ì´ˆê¸°í™”
            ['area-top', 'area-bottom', 'area-left', 'area-right'].forEach(id => {
                const el = document.getElementById(`area-${id}`);
                if (el) el.innerHTML = '';
            });

            document.getElementById('statusList').innerHTML = `<div class="flex items-center justify-center h-full text-slate-400 text-xs"><div class="animate-spin mr-2 rounded-full border-2 border-slate-300 border-t-slate-500 h-4 w-4"></div>ë¡œë”© ì¤‘...</div>`;

            // ê¸°ê¸° ë°°ì¹˜
            group.devices.forEach(device => {
                const btn = document.createElement('div');
                btn.className = 'device-btn';
                
                let content = '';
                const strNo = String(device.no);
                if (strNo.startsWith('NS') || strNo.startsWith('NL')) {
                    const type = strNo.substring(0,2); const num = strNo.substring(2);
                    content = `<span class="label-sm">${type}</span><span class="label-lg">${num}</span>`;
                } else {
                    content = `<span class="label-lg">${strNo}</span>`;
                }
                btn.innerHTML = content;
                btn.onclick = () => openModal(group.name, device.no);

                // ë‚´ë¶€ ê¸°ê¸° ì²˜ë¦¬
                if (document.getElementById(`area-${device.pos}`)) {
                    document.getElementById(`area-${device.pos}`).appendChild(btn);
                }
            });

            // ë°ì´í„° ë¡œë“œ
            fetchGroupData(group.name);

            // í™”ë©´ ì „í™˜
            document.getElementById('page-dashboard').classList.remove('active');
            document.getElementById('page-detail').classList.add('active');
            window.scrollTo(0,0);
        }

        function fetchGroupData(groupName) {
            if(GOOGLE_SCRIPT_URL.includes("ì—¬ê¸°ì—")) {
                document.getElementById('statusList').innerHTML = `<div class="text-center text-xs text-red-400 mt-4">URL ë¯¸ì„¤ì •</div>`;
                return;
            }
            
            fetch(`${GOOGLE_SCRIPT_URL}?group=${encodeURIComponent(groupName)}`)
                .then(res => res.json())
                .then(data => {
                    currentGroupData = data;
                    updateCenterStatus(data);
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('statusList').innerHTML = `<div class="text-center text-xs text-slate-400 mt-4">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>`;
                });
        }

        function updateCenterStatus(data) {
            const counts = {};
            STATUS_CATEGORIES.forEach(cat => counts[cat.code] = 0);

            data.forEach(item => {
                let code;
                if (item.device === 'NOTE') {
                    code = 'NOTE';
                } else {
                    code = getCategoryByAction(item.action);
                }
                
                if (counts[code] !== undefined) counts[code]++;
            });

            // í˜„í™©íŒ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
            let html = `<div class="status-header">ì •ë¹„ í˜„í™©</div><div id="statusListContent" class="status-list">`;
            STATUS_CATEGORIES.forEach((cat, idx) => {
                const count = counts[cat.code] || 0;
                const activeClass = count > 0 ? 'active' : '';
                html += `<div class="status-item ${activeClass}" onclick="openHistoryModal('${cat.code}')"><span>${idx+1}. ${cat.label}</span><span class="badge ${activeClass}">${count}ê±´</span></div>`;
            });
            html += `</div>`;
            document.getElementById('centerBox').innerHTML = html;

            // â˜…â˜…â˜… [ìˆ˜ì •] ë©”ëª¨ ê±´ìˆ˜ ë°°ì§€ ê°±ì‹  â˜…â˜…â˜…
            const memoCount = counts['NOTE'] || 0;
            const memoBadge = document.getElementById('memoCountBadge');
            if (memoBadge) {
                memoBadge.textContent = `${memoCount}ê±´`;
                if (memoCount > 0) {
                    memoBadge.classList.add('active');
                } else {
                    memoBadge.classList.remove('active');
                }
            }
        }

        // ëª¨ë‹¬ ë° í˜ì´ì§€ ì œì–´
        function goHome() { 
            document.getElementById('page-detail').classList.remove('active'); 
            document.getElementById('page-dashboard').classList.add('active');
            document.getElementById('memoInput').value = '';
        }
        function openModal(g, d) { currentSelection = { group: g, deviceNo: d }; document.getElementById('modalTitle').textContent = `No. ${d}`; document.getElementById('modalSubtitle').textContent = g; document.getElementById('actionModal').classList.remove('hidden'); document.getElementById('actionModal').classList.add('flex'); }
        function closeModal(id) {
            const modal = document.getElementById(id);
            modal.classList.remove('flex');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }
        
        function submitAction(action) {
            if(!currentSelection.group) return;
            const loading = document.getElementById('loadingOverlay');
            loading.classList.remove('hidden'); loading.classList.add('flex');
            closeModal('actionModal');
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST", mode: "no-cors",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({group: currentSelection.group, deviceNo: currentSelection.deviceNo, action: action})
            }).then(() => {
                loading.classList.add('hidden'); loading.classList.remove('flex');
                alert(`[${currentSelection.deviceNo} - ${action}] ì €ì¥ ì™„ë£Œ!`);
                fetchGroupData(currentSelection.group);
            }).catch(() => {
                loading.classList.add('hidden'); loading.classList.remove('flex');
                alert("ì „ì†¡ ì‹¤íŒ¨");
            });
        }

        function submitMemo() {
            const memoText = document.getElementById('memoInput').value;
            if(!memoText.trim()) {
                alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            if(!currentSelection.group) {
                alert("ê·¸ë£¹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            const loading = document.getElementById('loadingOverlay');
            loading.classList.remove('hidden'); loading.classList.add('flex');

            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST", mode: "no-cors",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    group: currentSelection.group, 
                    deviceNo: 'NOTE',  // ê¸°ê¸°ë²ˆí˜¸ ëŒ€ì‹  'NOTE'ë¡œ ì €ì¥
                    action: memoText   // ë‚´ìš©ì€ action í•„ë“œì— ì €ì¥
                })
            }).then(() => {
                loading.classList.add('hidden'); loading.classList.remove('flex');
                alert("íŠ¹ì´ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById('memoInput').value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
                fetchGroupData(currentSelection.group); // ë©”ëª¨ ì €ì¥ í›„ í˜„í™©íŒ ê°±ì‹ 
            }).catch(() => {
                loading.classList.add('hidden'); loading.classList.remove('flex');
                alert("ì €ì¥ ì‹¤íŒ¨");
            });
        }

        function openHistoryModal(code) {
            const cat = STATUS_CATEGORIES.find(c => c.code === code);
            document.getElementById('historyTitle').textContent = cat.label;
            const tbody = document.getElementById('historyListBody');
            const noMsg = document.getElementById('noHistoryMsg');
            tbody.innerHTML = '';
            
            let filtered;
            
            // â˜…â˜…â˜… [ìˆ˜ì •] NOTE ì½”ë“œ ì²˜ë¦¬ (ê¸°ê¸°ë²ˆí˜¸ê°€ 'NOTE'ì¸ ì´ë ¥ë§Œ í•„í„°ë§) â˜…â˜…â˜…
            if (code === 'NOTE') {
                filtered = currentGroupData.filter(d => d.device === 'NOTE');
            } else {
                // ì¼ë°˜ ì •ë¹„ í•­ëª©ì€ ê¸°ì¡´ ë¶„ë¥˜ ë¡œì§ ì‚¬ìš©
                filtered = currentGroupData.filter(d => d.device !== 'NOTE' && getCategoryByAction(d.action) === code);
            }
            
            if(filtered.length === 0) {
                noMsg.classList.remove('hidden');
            } else {
                noMsg.classList.add('hidden');
                filtered.forEach(item => {
                    // NOTE ë©”ëª¨ì˜ ê²½ìš°, ê¸°ê¸°ë²ˆí˜¸ ëŒ€ì‹  "ë©”ëª¨" í‘œì‹œ
                    const deviceDisplay = item.device === 'NOTE' ? 'ë©”ëª¨' : `No.${item.device}`;
                    
                    tbody.innerHTML += `
                        <tr>
                            <td class="px-4 py-3 font-medium text-slate-900 whitespace-nowrap">${item.date.substring(5)}</td>
                            <td class="px-2 py-3 font-bold ${item.device === 'NOTE' ? 'text-slate-500' : 'text-blue-600'}">${deviceDisplay}</td>
                            <td class="px-4 py-3 text-slate-500">${item.action}</td>
                        </tr>`;
                });
            }
            const modal = document.getElementById('historyModal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.add('flex'), 10);
        }

        initDashboard();
    </script>
</body>
</html>